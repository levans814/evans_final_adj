---
title: "R Notebook"
output: html_notebook
---

This is my notebook for my final project. I will be making a web application using shiny to show campaign finance information for the Missouri Senate race.

#Load packages
```{r}
library(shiny)
library(rsconnect)
library(tidyverse)
library(janitor)
```

#Load the data
```{r}
contributions <- read_csv("data/campfin/mo_contributions.csv")
candidates <- read_csv("data/campfin/candidates.csv")
committees <- read_csv("data/campfin/committees.csv")
```

#Documentation for these three tables: 

**Individual contributions**:
https://www.fec.gov/campaign-finance-data/contributions-individuals-file-description/
**Candidates**: 
https://www.fec.gov/campaign-finance-data/candidate-master-file-description/
**Committees**: 
https://www.fec.gov/campaign-finance-data/committee-master-file-description/

# DEAL WITH REFUNDS
Use function I found online to turn numeric data negative
```{r}
refunds <- contributions %>% filter(transaction_tp=="22Y") %>%
  mutate_if(is.numeric, funs(. * -1))
```
#Make table without 22y so it doesn't get zeroed out but actually negated
```{r}
no_refunds <- contributions %>% filter(transaction_tp!="22Y")
```
#Add in negative refunds
```{r}
clean_contribs<-no_refunds %>% add_row(refunds)
```

#narrow down to senate race and join candidates to clean_contribs
```{r}
party_contribs <- candidates %>% 
  filter(election_yr=="2022" & office_st=="MO" & office=="S") %>%
  inner_join(clean_contribs, by=c("pcc"="cmte_id")) %>%
  group_by(party) %>%
  summarise(total = sum(transaction_amt))
```

#totals for candidates, all, then remove blunt for graphs
```{r}
all_cand_totals <- candidates %>% 
  filter(election_yr=="2022" & office_st=="MO" & office=="S") %>%
  inner_join(clean_contribs, by=c("pcc"="cmte_id")) %>%
  group_by(cand_name) %>% 
  summarise(total=sum(transaction_amt)) %>% 
  arrange(desc(total))

new_names <-  sapply(strsplit(all_cand_totals$cand_name, split=", "),function(x) 
  {paste(rev(x),collapse=" ")}) %>%
    str_to_title()

all_no_blunt <- all_cand_totals %>% 
  filter(cand_name!="BLUNT, ROY")
```


#totals for candidates, republican, then remove blunt for graphs
```{r}
rep_cand_totals <- candidates %>% 
  filter(election_yr=="2022" & office_st=="MO" & office=="S") %>%
  inner_join(clean_contribs, by=c("pcc"="cmte_id")) %>%
  filter(party=="REP") %>% 
  group_by(cand_name) %>% 
  summarise(total=sum(transaction_amt)) %>% 
  arrange(desc(total))

rep_no_blunt <- rep_cand_totals %>% 
  filter(cand_name!="BLUNT, ROY")
```
#totals for cand, dems
```{r}
dem_cand_totals <- candidates %>% 
  filter(election_yr=="2022" & office_st=="MO" & office=="S") %>%
  inner_join(clean_contribs, by=c("pcc"="cmte_id")) %>%
  filter(party=="DEM") %>% 
  group_by(cand_name) %>% 
  summarise(total=sum(transaction_amt)) %>% 
  arrange(desc(total))
```
#totals for cands, unk
```{r}
unk_cand_totals <- candidates %>% 
  filter(election_yr=="2022" & office_st=="MO" & office=="S") %>%
  inner_join(clean_contribs, by=c("pcc"="cmte_id")) %>%
  filter(party=="UNK") %>% 
  group_by(cand_name) %>% 
  summarise(total=sum(transaction_amt))
```


#Run the shiny app template
```{r}
ui <- fluidPage(
  
  titlePanel("Missouri Senate Race"),
  
 verticalLayout(
   sidebarLayout(
    sidebarPanel( selectInput("var", 
                  label = "Choose a variable to display",
                  choices = c("Republican", "Democrat",
                              "Unknown"),
                  selected = "Republican"),
                p("After Sen. Roy Blunt announced he would not be running for reelection for the U.S. Senate, the race for his seat quickly became crowded. Browse this application to learn more about the funding behind the race for Missouri's open Senate seat."),

),
    
    mainPanel(
      tableOutput("table"),
      plotOutput("varPlot"))
  ),
),

 tags$hr(),  

h2("Totals"),
sidebarLayout(
    sidebarPanel(
      h4("Total contributions by party:"),
      tableOutput("TBL"),
      h4("Total contributions by candidate"),
      tableOutput("all_cands")
                     ),
    
    mainPanel(
      h3("Contribution sums for all candidates"),
      plotOutput("candPlot")
      )
  ),
tags$hr()  

)

server <- function(input, output){
  
  output$TBL <- renderTable({
      party_contribs
  })
  
  output$all_cands <- renderTable({
      all_cand_totals
  })
  
  output$table <- renderTable({data <- switch(input$var, 
                   "Republican" = rep_cand_totals,
                   "Democrat" = dem_cand_totals,
                   "Unknown" = unk_cand_totals)
  
})
  output$candPlot <- renderPlot(ggplot(all_no_blunt, aes(reorder(all_no_blunt$cand_name, all_no_blunt$total))) +
  geom_bar(aes(weight = all_no_blunt$total), fill = "#3CAEA3") + 
  coord_flip() +
  ggtitle("Total candidate contributions") +
  xlab("Candidate") +
  ylab("Sum of contributions") +
  theme_bw(base_size = 16))

output$varPlot <- renderPlot(ggplot({data <- switch(input$var, 
                   "Republican" = rep_no_blunt,
                   "Democrat" = dem_cand_totals,
                   "Unknown" = unk_cand_totals)}, aes(reorder(cand_name, total))) +
  geom_bar(aes(weight = total), fill = switch(input$var, 
                   "Republican" = "#ED5533",
                   "Democrat" = "#173F5F",
                   "Unknown" = "#F6D55C")) + 
  coord_flip() +
  ggtitle("Candidate contributions") +
  xlab("Candidate") +
  ylab("Sum of contributions") +
  theme_bw(base_size = 16))

}

shinyApp(ui=ui , server = server)

```

#Tasks!
- add reactive graphs!
- try to modify tables so they're easier to read -- column names, title case the cand names, add commas to the totals etc.
- add in a blurb about refunds, explaining Blunt negative
- style the web app (put non reactive total information in own column, make it prettier, etc.)
- add a normal p blurb about what the web app is, perhaps in the sidebar



#Note to Laura, tutorial timestamp 1:36:53 https://shiny.rstudio.com/tutorial/