---
title: "R Notebook"
output: html_notebook
---

This is my notebook for my final project. I will be making a web application using shiny to show campaign finance information for the Missouri Senate race.

#Load packages
```{r}
library(shiny)
library(rsconnect)
library(tidyverse)
library(janitor)
library(scales)
```

#Load the data
```{r}
contributions <- read_csv("data/campfin/mo_contributions.csv")
candidates <- read_csv("data/campfin/candidates.csv")
committees <- read_csv("data/campfin/committees.csv")
```

#Documentation for these three tables: 

**Individual contributions**:
https://www.fec.gov/campaign-finance-data/contributions-individuals-file-description/
**Candidates**: 
https://www.fec.gov/campaign-finance-data/candidate-master-file-description/
**Committees**: 
https://www.fec.gov/campaign-finance-data/committee-master-file-description/

# DEAL WITH REFUNDS
Use function I found online to turn numeric data negative
```{r}
refunds <- contributions %>% filter(transaction_tp=="22Y") %>%
  mutate_if(is.numeric, funs(. * -1))
```
#Make table without 22y so it doesn't get zeroed out but actually negated
```{r}
no_refunds <- contributions %>% filter(transaction_tp!="22Y")
```
#Add in negative refunds
```{r}
clean_contribs<-no_refunds %>% add_row(refunds)
```

#narrow down to senate race and join candidates to clean_contribs, no roy blunt
```{r}
party_contribs <- candidates %>% 
  filter(election_yr=="2022" & office_st=="MO" & office=="S" & cand_name!="BLUNT, ROY") %>%
  inner_join(clean_contribs, by=c("pcc"="cmte_id")) %>%
  group_by(party) %>%
  summarise(total = sum(transaction_amt))%>%
    mutate_each(funs(prettyNum(., big.mark=",")))
```

#totals for candidates, all, then remove blunt for graphs
```{r}
#names<-data.frame(Names = sapply(strsplit(all_cand_totals$cand_name, split=", "),function(x)  {paste(rev(x),collapse=" ")}) %>%
    #str_to_title())
#I got so frustrated by not knowing what to do with the Mr.s and Jr.s and the initials whatnot that I'm just going to write their names in a vector since there are only 13

names<- data.frame(names = c("Eric Schmitt", "Vicky J. Hartzler", "Billy Long", "Lucas Kunce", "Scott Sifton", "Eric Greitens", "Mark T. Mccloskey", "Spencer Ross Toder", "Jewel William Kelly Jr.", "Timothy Jacob Shepard", "Gena Ross", "Nicholas Crane Strauss", "Roy Blunt"))

all_cand_totals <- candidates %>% 
  filter(election_yr=="2022" & office_st=="MO" & office=="S") %>%
  inner_join(clean_contribs, by=c("pcc"="cmte_id")) %>%
  group_by(cand_name) %>% 
  summarise(total=sum(transaction_amt)) %>% 
  arrange(desc(total)) %>% 
  mutate(names, .before=1) %>% 
  select(names, total)

all_cand_commas <- all_cand_totals %>%
    mutate_each(funs(prettyNum(., big.mark=",")))

all_no_blunt <- all_cand_totals %>% 
  filter(names!="Roy Blunt")
```


#totals for candidates, republican, then remove blunt for graphs
```{r}
rep.names<- data.frame(names = c("Eric Schmitt", "Vicky J. Hartzler", "Billy Long", "Eric Greitens", "Mark T. Mccloskey", "Roy Blunt"))

rep_cand_totals <- candidates %>% 
  filter(election_yr=="2022" & office_st=="MO" & office=="S") %>%
  inner_join(clean_contribs, by=c("pcc"="cmte_id")) %>%
  filter(party=="REP") %>% 
  group_by(cand_name) %>% 
  summarise(total=sum(transaction_amt)) %>% 
  arrange(desc(total)) %>% 
  mutate(rep.names, .before=1) %>% 
  select(names, total)

rep_cand_commas <- rep_cand_totals %>% 
  mutate_each(funs(prettyNum(., big.mark=",")))

rep_no_blunt <- rep_cand_totals %>% 
  filter(names!="Roy Blunt")
```
#totals for cand, dems
```{r}
dem.names <- data.frame(names = c("Lucas Kunce", "Scott Sifton", "Spencer Ross Toder", "Jewel William Kelly Jr.", "Timothy Jacob Shepard", "Gena Ross"))

dem_cand_totals <- candidates %>% 
  filter(election_yr=="2022" & office_st=="MO" & office=="S") %>%
  inner_join(clean_contribs, by=c("pcc"="cmte_id")) %>%
  filter(party=="DEM") %>% 
  group_by(cand_name) %>% 
  summarise(total=sum(transaction_amt)) %>% 
  arrange(desc(total)) %>% 
  mutate(dem.names, .before=1) %>% 
  select(names, total)

dem_cand_commas <- dem_cand_totals%>%
    mutate_each(funs(prettyNum(., big.mark=",")))
```
#totals for cands, unk
```{r}
unk.name <- data.frame(names = c("Nicholas Crane Strauss"))

unk_cand_totals <- candidates %>% 
  filter(election_yr=="2022" & office_st=="MO" & office=="S") %>%
  inner_join(clean_contribs, by=c("pcc"="cmte_id")) %>%
  filter(party=="UNK") %>% 
  group_by(cand_name) %>% 
  summarise(total=sum(transaction_amt))%>% 
  mutate(unk.name, .before=1) %>% 
  select(names, total)

unk_cand_commas <- unk_cand_totals %>%
    mutate_each(funs(prettyNum(., big.mark=",")))
```


#Run the shiny app template
```{r}

ui <- fluidPage(
  
  h1("Missouri Senate Race"),
  
 verticalLayout(
   sidebarLayout(
    sidebarPanel( selectInput("var", 
                  label = "Choose a party to display",
                  choices = c("Republican", "Democrat",
                              "Unknown"),
                  selected = "Republican"),
                p("After Sen. Roy Blunt announced he would not be running for reelection for the U.S. Senate, the race for his seat quickly became crowded. Browse this application to learn more about the funding behind the race for Missouri's open Senate seat."),
                p("Senator Blunt's contribution sum returns negative, as Blunt has issued refunds to donors. As such, Blunt has been excluded from the graphs on this website."),
p("This data is taken from the Federal Exchange Commission's website. It was accessed in late February, so the information is not up to date."),
tags$a(href="https://www.fec.gov/campaign-finance-data/", "Click here to access the FEC's campaign finance data.")
),
    
    mainPanel(
      tableOutput("table"),
      plotOutput("varPlot")
     )
  ),
),

 tags$hr(),  

h2("Totals"),
sidebarLayout(
    sidebarPanel(
      h4("Total contributions by party:"),
      tableOutput("TBL"),
      h4("Total contributions by candidate"),
      tableOutput("all_cands")
                     ),
    
    mainPanel(
      h3("Contribution sums for all candidates"),
      plotOutput("candPlot")
      )
  ),
tags$hr()  

)

server <- function(input, output){
  
  output$TBL <- renderTable({
      party_contribs
  })
  
  output$all_cands <- renderTable({
      all_cand_commas
  })
  
  output$table <- renderTable({data <- switch(input$var, 
                   "Republican" = rep_cand_commas,
                   "Democrat" = dem_cand_commas,
                   "Unknown" = unk_cand_commas)
  
})
  output$candPlot <- renderPlot(ggplot(all_no_blunt, aes(reorder(all_no_blunt$names, all_no_blunt$total))) +
  geom_bar(aes(weight = all_no_blunt$total), fill = "#3CAEA3") + 
  coord_flip() +
  ggtitle("Total candidate contributions") +
  xlab("Candidate") +
  ylab("Sum of contributions") +
  theme_bw(base_size = 16))

output$varPlot <- renderPlot(ggplot({data <- switch(input$var, 
                   "Republican" = rep_no_blunt,
                   "Democrat" = dem_cand_totals,
                   "Unknown" = unk_cand_totals)}, aes(reorder(names, total))) +
  geom_bar(aes(weight = total), fill = switch(input$var, 
                   "Republican" = "#ED5533",
                   "Democrat" = "#173F5F",
                   "Unknown" = "#F6D55C")) + 
  coord_flip() +
  ggtitle("Candidate contributions") +
  xlab("Candidate") +
  ylab("Sum of contributions") +
  theme_bw(base_size = 16))

}

shinyApp(ui=ui , server = server)

```

#Tasks!
- add reactive graphs!
- try to modify tables so they're easier to read -- column names, title case the cand names, add commas to the totals etc.
- add in a blurb about refunds, explaining Blunt negative
- style the web app (put non reactive total information in own column, make it prettier, etc.)
- add a normal p blurb about what the web app is, perhaps in the sidebar

#Deploy app?
```{r}
rsconnect::deployApp()
```


#Note to Laura, tutorial timestamp 1:36:53 https://shiny.rstudio.com/tutorial/